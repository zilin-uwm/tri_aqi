library(readr)
uber_apr <- read_csv("/Users/zhangzilin/Desktop/Data_sourse/uber-raw-data-apr14.csv")
uber_may <- read_csv("/Users/zhangzilin/Desktop/Data_sourse/uber-raw-data-may14.csv")
uber_xjun <- read_csv("/Users/zhangzilin/Desktop/Data_sourse/uber-raw-data-jun14.csv")
uber_jul <- read_csv("/Users/zhangzilin/Desktop/Data_sourse/uber-raw-data-jul14.csv")
uber_aug <- read_csv("/Users/zhangzilin/Desktop/Data_sourse/uber-raw-data-aug14.csv")
uber_sep <- read_csv("/Users/zhangzilin/Desktop/Data_sourse/uber-raw-data-sep14.csv")

library(dplyr)
uber14 <- bind_rows(uber_apr, uber_may, uber_jun, uber_jul, uber_aug, uber_sep)

library(lubridate)
library(anytime)
uber14$`Date/Time` <- mdy_hms(uber14$`Date/Time`)
uber14 <- uber14 %>% mutate(year = year(`Date/Time`),
                            month = month(`Date/Time`),
                            monthname = month(`Date/Time`, label = TRUE, abbr = FALSE),
                            day = day(`Date/Time`),
                            weekday = wday(`Date/Time`, label = TRUE, abbr = FALSE),
                            hour = hour(`Date/Time`),
                            minute = minute(`Date/Time`))


aqistat_list<- data_frame(x1=aqistat.x,x2=aqistat.y,x3="aqi")
aqistat_list<-aqistat_list[!duplicated(aqistat_list),]
uber_list<-data_frame(x1=uber.x,x2=uber.y,x3="tra")
poi_list<-data_frame(x1=poi.x,x2=poi.y,x3="poi")

AQI=subset(AQI,SITE_LATITUDE<=40.94787907 & SITE_LATITUDE>=40.45325666 & SITE_LONGITUDE<=-73.70741171 & SITE_LONGITUDE>=-74.27480126)
new_data<-rbind(uber_list,poi_list,aqistat_list)
ggplot(new_data, aes(x = x1, y = x2, colour = x3)) +geom_point()

AQI<-subset(AQI,`Site ID`==340030010 | `Site ID`==340130003 | `Site ID`==340131003| `Site ID`==340170006 | `Site ID`==340171002| `Site ID`==340171003| `Site ID`==340390003| `Site ID`==340390004| `Site ID`==360050110)

uber_14<-subset(uber_2014,Lat<=40.94787907 & Lat>=40.45325666 & Lon<=-73.70741171 & Lon>=-74.27480126)
uber_2014$Base[which(uber_2014$Base=="B02512")]<-'1'
View(uber_2014)
View(uber_2014)
uber_2014$Base[which(uber_2014$Base=="B02598")]<-'2'
uber_2014$Base[which(uber_2014$Base=="B02617")]<-'3'
uber_2014$Base[which(uber_2014$Base=="B02682")]<-'4'
uber_2014$Base[which(uber_2014$Base=="B02764")]<-'5'
plot(uber_2014$Lon,uber_2014$Lat,xlim=c(-74.27480126,-73.70741171),ylim=c(40.45325666,40.94787907),col=uber_2014$Base,cex=1,pch=20,xlab='Lon',ylab='Lat')+grid(nx=10,ny=10,lwd=2,col="black")







#dbscan
data <- read_csv("/Users/zhangzilin/Desktop/paper/DataSet/available/useful/traDATA4.csv")
data2=data$Lat_lon_count
data$sum=data2
for(i in 1:nrow(data)){
  for(j in 1:nrow(data)){
    if(data$date[i]==data$date[j] && abs(data$x[i]-data$x[j])<2 && abs(data$y[i]-data$y[j])<2)
      data$sum[i]=data$sum[i]+data$Lat_lon_count[j]
  }
}
data$sum = data$sum-data$Lat_lon_count


#dcount by date
datad = data
datad2 = datad$Lat_lon_count
datad$diff = datad2 - datad2
for(i in 1:nrow(datad)){
  for(j in 1:nrow(datad)){
    if(difftime(datad$date[i], datad$date[j], units="days") ==1 && datad$x[i]==datad$x[j] && datad$y[i]==datad$y[j])
    datad$diff[i] = datad$Lat_lon_count[i]-datad$Lat_lon_count[j]
  }
}
data$sum = data$sum-data$Lat_lon_count

#dcount by date(ratio)
datapro<-read_csv("/Users/zhangzilin/Desktop/paper/DataSet/result/Data123.csv")
datad3 = datapro$Lat_lon_count
datapro$diffbyratio = datad3 - datad3
for(i in 1:nrow(datapro)){
  for(j in 1:nrow(datapro)){
    if(difftime(datapro$date[i], datapro$date[j], units="days") ==1 && datapro$x[i]==datapro$x[j] && datapro$y[i]==datapro$y[j])
      datapro$diffbyratio[i] = datapro$ratio[i]-datapro$ratio[j]
  }
}

#dcount by date by ratio
datadr<-read_csv("/Users/zhangzilin/Desktop/paper/DataSet/result/Data111.csv")
datad4 = datadr$Lat_lon_count
datadr$sumavg = datad4
for(i in 1:nrow(datadr)){
  for(j in 1:nrow(datadr)){
    if(datadr$date[i]==datadr$date[j] && abs(datadr$x[i]-datadr$x[j])<2 && abs(datadr$y[i]-datadr$y[j])<2)
      datadr$sumavg[i]=datadr$sumavg[i]+datadr$Lat_lon_count[j]*abs(datadr$diffbyratio[j])
  }
}
datadr$sumavg = datadr$sumavg-datadr$Lat_lon_count


#panel
install.packages("mice")##???????????????
install.packages("plm")
install.packages("MSBVAR")

library(plm)
library(MSBVAR)
library(tseries)
library(xts)
library(mice)

dataaqi<-read.csv("/Users/zhangzilin/Desktop/paper/DataSet/available/useful/AQI34.csv")
#???????????????
tlist1<-xts(dataaqi$Daily.Max.8.hour.CO.Concentration,as.Date(dataaqi$date))
adf.test(tlist1)
tlist2<-xts(dataaqi$Daily.Max.1.hour.NO2.Concentration,as.Date(dataaqi$date))
adf.test(tlist2)
tlist3<-xts(dataaqi$Daily.Max.8.hour.Ozone.Concentration,as.Date(dataaqi$date))
adf.test(tlist3)
tlist4<-xts(dataaqi$Daily.Mean.Pb.Concentration,as.Date(dataaqi$date))
adf.test(tlist4)
tlist5<-xts(dataaqi$Daily.Max.1.hour.SO2.Concentration,as.Date(dataaqi$date))
adf.test(tlist5)
tlist6<-xts(dataaqi$Daily.Mean.PM2.5.Concentration,as.Date(dataaqi$date))
adf.test(tlist6)
tlist7<-xts(dataaqi$Daily.Mean.PM10.Concentration,as.Date(dataaqi$date))
adf.test(tlist7)
tlist8<-xts(dataaqi$AQI,as.Date(dataaqi$date))
adf.test(tlist8)

#???????????????
grangertest(Daily.Max.8.hour.CO.Concentration ~ AQI, order = 2, data = dataaqi)
grangertest(Daily.Max.1.hour.NO2.Concentration ~ AQI, order = 2, data = dataaqi)
grangertest(Daily.Max.8.hour.Ozone.Concentration ~ AQI, order = 2, data = dataaqi)
grangertest(Daily.Mean.Pb.Concentration ~ AQI, order = 2, data = dataaqi)
grangertest(Daily.Max.1.hour.SO2.Concentration ~ AQI, order = 2, data = dataaqi)
grangertest(Daily.Mean.PM2.5.Concentration ~ AQI, order = 2, data = dataaqi)
grangertest(Daily.Mean.PM10.Concentration ~ AQI, order = 2, data = dataaqi)

#CO PB PM2.5 PM10 ??? aqi ???????????????
#????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????? 
#???????????????????????????????????????????????????????????????????????????????????????????????????????????????

form<- lm(dataaqi$AQI ~ dataaqi$Daily.Max.8.hour.CO.Concentration + dataaqi$Daily.Mean.Pb.Concentration+dataaqi$Daily.Mean.PM2.5.Concentration+dataaqi$Daily.Mean.PM10.Concentration)
rankData<-plm.data(dataaqi,index=c("Site.ID","date"))#?????????????????????
pool <- plm(form,data=rankData,model="pooling")#????????????
pooltest(form,data=rankData,effect="individual",model="within")#??????????????????????????????
pooltest(form,data=rankData,effect="time",model="within")#?????????????????????????????????
wi<-plm(form,data=rankData,effect="twoways",model="within")#???????????????????????????????????????
pooltest(pool,wi)#F???????????????????????????????????????????????????
phtest(form,data=rankData)##Hausman????????????????????????????????????,????????????????????????
pbgtest(form,data=rankData,model="within")#LM??????,????????????????????????
#??????????????????????????????
pwartest(form,data=rankData)#Wooldridge??????(?????????)??????0.05??????????????????
summary(wi)##????????????????????????
fixef(wi,effect="time")#?????????????????????????????????????????????????????????
inter<-fixef(wi,effect="individual")#?????????????????????????????????????????????????????????

##?????????????????????????????????;


dataaqi1<-dataaqi[month(dataaqi$date)==4,]
ggplot(dataaqi1,aes(date(date),AQI,group=factor(Site.ID),color=factor(Site.ID),shape=factor(Site.ID),xlab="Date"))+geom_point()+geom_line()+xlab('Date')
dataaqi2<-dataaqi[dataaqi$Site.ID=='340030010' & month(dataaqi$date)==4,]


form<-dataaqi$AQI~dataaqi$Daily.Max.8.hour.CO.Concentration + dataaqi$Daily.Mean.Pb.Concentration+dataaqi$Daily.Mean.PM2.5.Concentration+dataaqi$Daily.Mean.PM10.Concentration
rankData<-plm.data(dataaqi,index=c("Site.ID","date"))
pool <- plm(form,data=rankData,model="pooling")#????????????
pooltest(form,data=rankData,effect="individual",model="within")#??????????????????????????????
pooltest(form,data=rankData,effect="time",model="within")#?????????????????????????????????
wi<-plm(form,data=rankData,effect="twoways",model="within")#???????????????????????????????????????
pooltest(pool,wi)#F???????????????????????????????????????????????????
phtest(form,data=rankData)##Hausman????????????????????????????????????,????????????????????????
pbgtest(form,data=rankData,model="within")#LM??????,????????????????????????
#??????????????????????????????
pwartest(form,data=rankData)#Wooldridge??????(?????????)??????0.05??????????????????
summary(wi)##????????????????????????
fixef(wi,effect="time")#?????????????????????????????????????????????????????????
inter<-fixef(wi,effect="individual")#?????????????????????????????????????????????????????????




form4<-dataaqi$AQI~lag(dataaqi$Daily.Max.8.hour.CO.Concentration,1) + lag(dataaqi$Daily.Mean.Pb.Concentration,1)+lag(dataaqi$Daily.Mean.PM2.5.Concentration,1)+lag(dataaqi$Daily.Mean.PM10.Concentration,1)
rankData<-plm.data(dataaqi,index=c("Site.ID","date"))
pool <- plm(form4,data=rankData,model="pooling")#????????????
pooltest(form4,data=rankData,effect="individual",model="within")#??????????????????????????????
pooltest(form4,data=rankData,effect="time",model="within")#?????????????????????????????????
wi<-plm(form4,data=rankData,effect="twoways",model="within")#???????????????????????????????????????
pooltest(pool,wi)#F???????????????????????????????????????????????????
phtest(form4,data=rankData)##Hausman????????????????????????????????????,????????????????????????
pbgtest(form4,data=rankData,model="within")#LM??????,????????????????????????
#??????????????????????????????
pwartest(form4,data=rankData)#Wooldridge??????(?????????)??????0.05??????????????????
summary(wi)##????????????????????????
fixef(wi,effect="time")#?????????????????????????????????????????????????????????
inter<-fixef(wi,effect="individual")#?????????????????????????????????????????????????????????




wi<-plm(form,data=a,model="within")
re<-plm(form,data=a,model="random")
phtest(wi,re)
pooltest(form,data=rankData,effect="individual",model="within")
pooltest(form,data=rankData,effect="time",model="within")

panel9<-panel[panel$Site.ID=='360050110',]
panel9[31:60,]$AQI=panel9[31:60,]$AQI+5
ggplot(panel9,aes(date(date),AQI,group=factor(tag),color=factor(tag),xlab="Date"))+geom_point()+geom_line()+xlab('Date')+ labs(title = "                                 Site ID:360050110")

???????????????????????????????????????????????????r???????????????????????????????????? easy
2.aqi?????????????????????????????????????????????????????????????????????dbscan???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????grid index???
3.??????????????????

?????????????????????????????????
????????????
aqi

#?????????????????????
reg1 <- read_csv("/Users/zhangzilin/Desktop/aqi ts pic/aqiuse.csv")
lm1<-lm(AQI~aqifcst+poi_ratio+Temperature_daily_mean_2m_above_gnd+Relative_Humidity_daily_mean_2m_above_gnd+Mean_Sea_Level_Pressure_daily_mean_MSL+Total_Precipitation_high_resolution_daily_sum_sfc+Total_Cloud_Cover_daily_mean_sfc+Sunshine_Duration_daily_sum_sfc+Wind_Speed_daily_mean_10m_above_gnd+Wind_Direction_daily_mean_10m_above_gnd+Temperature_daily_max_2m_above_gnd+Temperaturedaily_min_2m_above_gnd+Relative_Humidity_daily_max_2_m_above_gnd+Relative_Humidity_daily_min_2m_above_gnd+Mean_Sea_Level_Pressure_daily_max_MSL+Mean_Sea_Level_Pressure_daily_min_MSL+Total_Cloud_Cover_daily_max_sfc+Total_Cloud_Cover_daily_min_sfc+ Wind_Speed_daily_max_10_m_above_gnd+Wind_Speed_daily_min_10m_above_gnd,data=reg1)
lm1
summary(lm1)

par(mfrow=c(2,2))
plot(lm1)


x1<-xxx1[xxx1$Site.ID=='360050110',]
ggplot(x1,aes(date(date),AQI,group=factor(tag),color=factor(tag),shape=factor(Site.ID),xlab="Date"))+geom_point()+geom_line()+xlab('Date')+ labs(title = "                                 Site ID:360050110")


x1<-xxx1[xxx1$Site.ID=='340030010',]
ggplot(x1,aes(date(date),AQI,group=factor(tag),color=factor(tag),shape=factor(Site.ID),xlab="Date"))+geom_point()+geom_line()+xlab('Date')+ labs(title = "                                 Site ID:340030010")
x1<-xxx1[xxx1$Site.ID=='340130003',]
ggplot(x1,aes(date(date),AQI,group=factor(tag),color=factor(tag),shape=factor(Site.ID),xlab="Date"))+geom_point()+geom_line()+xlab('Date')+ labs(title = "                                 Site ID:340130003")
x1<-xxx1[xxx1$Site.ID=='340131003',]
ggplot(x1,aes(date(date),AQI,group=factor(tag),color=factor(tag),shape=factor(Site.ID),xlab="Date"))+geom_point()+geom_line()+xlab('Date')+ labs(title = "                                 Site ID:340131003")
x1<-xxx1[xxx1$Site.ID=='340170006',]
ggplot(x1,aes(date(date),AQI,group=factor(tag),color=factor(tag),shape=factor(Site.ID),xlab="Date"))+geom_point()+geom_line()+xlab('Date')+ labs(title = "                                 Site ID:340170006")
x1<-xxx1[xxx1$Site.ID=='340171002',]
ggplot(x1,aes(date(date),AQI,group=factor(tag),color=factor(tag),shape=factor(Site.ID),xlab="Date"))+geom_point()+geom_line()+xlab('Date')+ labs(title = "                                 Site ID:340171002")
x1<-xxx1[xxx1$Site.ID=='340171003',]
ggplot(x1,aes(date(date),AQI,group=factor(tag),color=factor(tag),shape=factor(Site.ID),xlab="Date"))+geom_point()+geom_line()+xlab('Date')+ labs(title = "                                 Site ID:340171003")
x1<-xxx1[xxx1$Site.ID=='340390003',]
ggplot(x1,aes(date(date),AQI,group=factor(tag),color=factor(tag),shape=factor(Site.ID),xlab="Date"))+geom_point()+geom_line()+xlab('Date')+ labs(title = "                                 Site ID:340390003")
x1<-xxx1[xxx1$Site.ID=='340390004',]
ggplot(x1,aes(date(date),AQI,group=factor(tag),color=factor(tag),shape=factor(Site.ID),xlab="Date"))+geom_point()+geom_line()+xlab('Date')+ labs(title = "                                 Site ID:340390004")
x1<-xxx1[xxx1$Site.ID=='360050110',]
ggplot(x1,aes(date(date),AQI,group=factor(tag),color=factor(tag),shape=factor(Site.ID),xlab="Date"))+geom_point()+geom_line()+xlab('Date')+ labs(title = "                                 Site ID:360050110")